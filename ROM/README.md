
# ROM contents

This folder contains files and code to build a ROM image that can be burned into the 512k ROM on the board, so that it actually boots.

- iplldr.a65: initial program loader, boots the machine by:
-- copying over character ROM image from start of ROM ($0f0000) to start of bank 7 (in RAM)
-- letting the user select which machine to boot (BASIC 2, BASIC 4/40 columns, BASIC 4/80 columns)
-- copying over selected PET ROM image to bank 0 ($a000-$ffff) ...
-- and executes a JMP through the RESET vector

For this work the ROM needs to contain:
- boot code
- character ROM
- system ROMs

## SPI FLash Memory Map

The IPL triggered by the CPLD loads the first 256 byte from the SPI flash. Following that is the
rest of the boot code as loaded by the initial IPL loader.
Then follow the various ROM images.

	Boot Image
        
        +----+ $1ffff
        |    |         SD-Card DOS code
        |    |         (16k)
        |    |
        +----+ $1c000
        |    |         USB driver code
        |    |         (8k)
        +----+ $1a000
        |    |         BASIC 1 alternate charrom 
        |    |         (as 16 byte/char)
        +----+ $18000
        |    |         8x BASIC 4 EDITOR
         ...           ROM images ($e000-$efff)
        |    |         Extended/orig, 40/80 columns, N-type/C64 kbd
        |    |
        +----+ $10000
        |    |         BASIC 4 Kernal ROM image
        +----+ $0F000
        |    |         BASIC 4 
        |    |         ROM image ($b000-$dfff)
        |    |         
        +----+ $0c000
        |    |         BASIC 2 
        |    |         ROM image ($c000-$ffff)
        |    |  
        |    |       
        +----+ $08000
        |    |         BASIC 1 
        |    |         ROM image ($c000-$ffff)
        |    |
        |    |
        +----+ $04000
        |    |         8k PET charrom
        |    |         (16 byte per character)
        +----+ $02000
        |    |         4k @MON in the PET4 variant (without editor extension)
        +----+ $01000
        |    |         Boot loader, first 256 byte IPL's by CPLD
        +----+ $00000

## Build

To build the ROM, just run "make".
This build process for bootimg downloads the necessary ROM images and sub-repos from the internet, builds the boot loader, and combines everything into a single boot image.
Then burn the resulting file "spiimg" into the lowest bank of the SPI Flash ROM (Address 0)

## Files

The following files are test files, or to build the ROMs:

- char8to16.c: converts a character ROM with 8 pixel rows per character to a 16 row per character image
- charPet2Invers.c: a PET charrom is only 2k and lacks inverted characters, as they are generated by hardware. This small program creates, from the 2k PET image, a full 4k image that contains the inverted characeters
- edit....asm: control files for Steve Gray's editor ROM project, to build the custom editor ROMs
-- edit40gx: 40 column for graphics keyboard with wedge and special keys
-- edit80gx: 80 column for graphics keyboard with wedge and special keys
-- edit40gxc: 40 column for C64 keyboard with wedge and special keys
-- edit80gxc: 80 column for C64 keyboard with wedge and special keys
-- edit40gc: 40 column for C64 keyboard (no further extensions) 
-- edit80gc: 80 column for C64 keyboard (no further extensions)

## ROM features

The editor ROMs are non-standard, and feature some extensions.
Note that they are only available for BASIC 4 variants. BASIC 1 and 2 are only just that.

### Extended versus Base ROMs

In the boot menu you can select the various model. By default the 
extended editor ROM is loaded where available (i.e. including wedge and special keys).
If you select the model while pressing the LEFT SHIFT, the unmodified ROM
is loaded. One exception: there is no original 80 column N-type keyboard ROM, so 
a contemporary adaption is used.

The BASIC 1 Kernal has the problem that its IEEE488 routines are broken.
Therefore, by default, a version that is patched to fix this is loaded,
so IEEE488 can be used. Selecting "1" with LEFT-SHIFT pressed installs
the original BASIC 1 ROMs.

Note that pressing the RIGHT SHIFT is not what you want. Doing this on the
N-type keyboard makes the select routing think you are using a C64 keyboard
instead, and the machine becomes unusable.

### Graphics keyboard ROMs

These are derived from the standard PET ROMs, but feature some extensions:

1. Shift + '@': switch between text and graphics display.
1. '@' + Left-Shift + Right-Shift + DEL: reset the PET

### C64 keyboard ROMs

The ...gc ROM files enable the use of a C64 keyboard instead of a PET graphics keyboard. 
The initial boot loader, where the model is selected detects the keyboard used using the numbers
pressed to select the model, and automatically loads the correct ROM.

Note that due to code size restrictions, only the normal and shifted keys are supported. CBM and Control
are currently ignored.

The follwing features are present:

1. Shift + Left-Arrow: switch between text and graphics display.
1. Ctrl + Left-Shift + Right-Shift + DEL: reset the PET

### Extended machine language monitor

In the ROM area at $a000 there is the @MON machine language monitor included (with assembler
and disassembler, and versatile search functions). 

Note that the scrolling editor is (for now) disabled due to incompatibilities with the modified
editor ROMs.

## Runtime Memory Map

When the different ROM versions are used, the memory map is installed as follows:

### BASIC 1 & 2

	Video RAM 
        
        +----+ $0fffff
        |    |
         ...           free
        |    |
        +----+ $089000
        |    |         Video data (mapped to bank 0)
        +----+ $088000
        |    |
         ...           free
        |    |
        +----+ $082000
        |    |         character ROM
        |    |         (two sets, 8k total, as 16 byte/char)
        +----+ $080000

	Fast RAM

        +----+ $07ffff
        |    |  
         ...           free
        |    |
        +----+ $010000
        |    |         BASIC 1/2 Kernal ROM image
        |    |
        +----+ $00F000
        |    |         BASIC 1/2 Editor 
        |    |         with I/O window at $E8xx
        +----+ $00E000
        |    |         BASIC 1/2 
        |    |         ROM image ($c000-$ffff)
         ...          
        |    |
        +----+ $00C000
        |    |
         ...           free
        |    |
        +----+ $009000
        |    |         Video window (mapped from Video RAM
        +----+ $008000
        |    |         32k BASIC RAM
         ...          
        |    |        
        +----+ $000400
        |    |         system variables
        +----+ $000200
        |    |         CPU stack
        +----+ $000100
        |    |         zeropage variables
        +----+ $000000

### BASIC 4

With BASIC 4 there are multiple options that need to be considered:

1. CBM 8x96 memory map emulation
2. USB and SD-Card support

	Video RAM 
        
        +----+ $0fffff
        |    |
         ...           free
        |    |
        +----+ $089000
        |    |         Video data (mapped to bank 0)
        +----+ $088000
        |    |
         ...           free
        |    |
        +----+ $082000
        |    |         character ROM
        |    |         (two sets, 8k total, as 16 byte/char)
        +----+ $080000

	Fast RAM

        +----+ $07ffff
        |    |  
        +----+ $078000
        |    |         USB- and SD-Card support bank, mapped 
        |    |         into lower half of bank 0 when active
        +----+ $070000
        |    |  
         ...           free
        |    |
        +----+ $020000
        |    |         8x96 extension memory, can be mapped in two chunks
        |    |         with 16k each into upper half of bank 0 using $fff0
        +----+ $010000                                   +----+   +----+  $00FFFF
        |    |         BASIC 4 Kernal ROM image          |    |   |    |
        |    |                                           |    |   |    |  Two sets of 16k pages
        +----+ $00F000                                   |    |   |    |  mapped from bank 1
        |    |         BASIC 4 Editor - multiple options |    |   |    |
        |    |         with I/O window at $E8xx          |    |   |    |
        +----+ $00E000                                   |    |   |    |
        |    |         BASIC 4                           |====|   |====|  optional peek-through to I/O
        |    |         ROM image ($b000-$ffff)           |    |   |    |
         ...                                             +----+   +----+  $00C000
        |    |                                           |    |   |    |
        +----+ $00B000                                   |    |   |    |  Two sets of 16k pages
        |    |         Extended @ASS monitor             |    |   |    |  mapped from bank 1
        |    |         (start with SYS49060)             |    |   |    |
        +----+ $00A000                                   |    |   |    |
        |    |         free                              |    |   |    |
        +----+ $009000                                   |----|   |----|
        |    |         Video window (mapped from VRAM)   |    |   |    |  optional peek-through to video
        +----+ $008000                                   +----+   +----+  $008000
        |    |         32k BASIC RAM                     |    |
         ...                                             |    |
        |    |                                           |    |
        +----+ $000400                                   |    |  Any of the 16 32k pages
        |    |         system variables                   ...    in bank 0, mapped
        +----+ $000200                                   |    |  using Memory bank register $e802
        |    |         CPU stack                         |    |
        +----+ $000100                                   |    |
        |    |         zeropage variables                |    |
        +----+ $000000                                   +----+   $000000

### USB/SD-Card map

The USB driver and the SD-Card DOS code are run mapping their 32k area into the
lower half of bank 0. There they can use their own zeropage or even stack if needed.

The boot code copies the files from the SPI image there and, if needed, patches
the BASIC4/KERNAL4 in place to link the USB/SD-Card support in.

The currently used memory is as follows:

#### USB driver

Zeropage reserved: $02-$10
Code/Data reserved: $1000-$3000

These values come from the reloc65 (-v) output in the usb65/platform/upet build code when creating the 
ROM image.

text segment @ $1000 - $24a3,  5283 ($14a3) bytes
data segment @ $24a3 - $28b2,  1039 ($040f) bytes
bss  segment @ $28b2 - $2a93,   481 ($01e1) bytes
zero segment @ $0002 - $0011,    15 ($000f) bytes

#### SD-Card / DOS

Zeropage reserved: $10-$20
Code/Data reserved: $3000-$8000

These values are configured in the ca65/ld65 linker configuration:

ZPDOS:    start = $0010, size = $000B;
DOS:      start = $4000, size = $4000, fill=yes, fillval=$AA;
DOSDAT:   start = $3000, size = $1000; 

